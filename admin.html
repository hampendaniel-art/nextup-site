<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Admin • NextUp</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
  <main class="max-w-4xl mx-auto p-6">
    <h1 class="text-2xl font-bold">NextUp Admin</h1>
    <div id="authArea"></div>
    <div id="submissions"></div>
  </main>

<script type="module">
import { auth, db, provider } from './firebase-init.js';
import { signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
import { collection, query, where, onSnapshot, doc, getDoc, addDoc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';

const authArea = document.getElementById('authArea');
const subsEl = document.getElementById('submissions');

function setSignedInUI(user){
  authArea.innerHTML = \`Signed in as \${user.email} <button id="signOutBtn">Sign out</button>\`;
  document.getElementById('signOutBtn').addEventListener('click', ()=> signOut(auth));
}

auth.onAuthStateChanged(user=>{
  if(user) setSignedInUI(user);
  else authArea.innerHTML = '<button id="signInBtn">Sign in with Google</button>';
  document.getElementById('signInBtn')?.addEventListener('click', async ()=> {
    await signInWithPopup(auth, provider);
  });
});

const q = query(collection(db, 'submissions'), where('status','==','pending'));
onSnapshot(q, snap => {
  subsEl.innerHTML = '';
  if(snap.empty) subsEl.innerHTML = '<p>No pending submissions.</p>';
  snap.docs.forEach(d=>{
    const s = d.data();
    const node = document.createElement('div');
    node.className = 'p-4 mb-4 bg-white rounded shadow';
    node.innerHTML = \`
      <h3 class="font-semibold">\${s.title || '(no title)'}</h3>
      <p>\${s.location || ''} • \${s.start || ''}</p>
      <p class="text-sm mt-2">\${(s.description||'')}</p>
      <div class="mt-3"><button data-id="\${d.id}" class="approveBtn px-3 py-1 rounded bg-green-600 text-white">Approve</button>
      <button data-id="\${d.id}" class="rejectBtn px-3 py-1 rounded border">Reject</button></div>
    \`;
    subsEl.appendChild(node);
  });

  subsEl.querySelectorAll('.approveBtn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const id = e.currentTarget.dataset.id;
      const docRef = doc(db, 'submissions', id);
      const snap = await getDoc(docRef);
      if(!snap.exists()) return alert('Submission missing');
      const data = snap.data();
      // create event in 'events' collection
      const ev = Object.assign({}, data);
      ev.publishedAt = serverTimestamp();
      ev.status = 'published';
      await addDoc(collection(db, 'events'), ev);
      await updateDoc(docRef, { status: 'approved', approvedAt: serverTimestamp() });
      alert('Approved and published');
    });
  });

  subsEl.querySelectorAll('.rejectBtn').forEach(btn => {
    btn.addEventListener('click', async (e)=>{
      const id = e.currentTarget.dataset.id;
      await updateDoc(doc(db, 'submissions', id), { status: 'rejected', rejectedAt: serverTimestamp() });
      alert('Rejected');
    });
  });

}, err => console.error(err));
</script>
</body>
</html>
