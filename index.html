<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NextUp â€¢ Local Events</title>
<link rel="icon" href="favicon.ico">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">

<nav class="bg-white shadow">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <a href="index.html" class="font-bold text-purple-600">NextUp</a>
    <div class="space-x-4 text-sm">
      <a href="submit.html" class="hover:underline">Submit Event</a>
      <a href="saved.html" class="hover:underline">Saved</a>
    </div>
  </div>
</nav>

<main class="max-w-6xl mx-auto p-6">
  <h1 class="text-3xl font-bold mb-4">Find Local Events</h1>
  <input id="search" placeholder="Search events..." 
         class="w-full border p-2 rounded mb-6">

  <div id="events" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</main>

<footer class="bg-gray-900 text-gray-300 py-6 text-center">
  &copy; 2025 NextUp
</footer>

<script>
// ðŸ”¹ Your published Sheet CSV (replace with your actual one)
const SHEET_CSV_URL =
 "https://docs.google.com/spreadsheets/d/e/2PACX-1vTVoIxW-FLTTEXSKMZcp7CWPm2KwEQ0T27rLnvTFeAwyeaJjxGb3Rx43BgMwdIBudOB2y4tmKCTshob/pub?output=csv";

// ðŸ”¹ Your Apps Script Web App URL (paste the same as in submit.html)
const FORM_ENDPOINT = "YOUR_WEBAPP_URL_HERE";

// Parse CSV from Sheet
async function fetchSheetEvents() {
  return new Promise((resolve, reject) => {
    Papa.parse(SHEET_CSV_URL, {
      download: true,
      header: true,
      complete: results => resolve(results.data),
      error: err => reject(err)
    });
  });
}

// Fetch recent submissions from Apps Script endpoint
async function fetchSubmissions() {
  try {
    const res = await fetch(FORM_ENDPOINT + "?action=list");
    if (!res.ok) return [];
    return await res.json();
  } catch (e) {
    console.error("No submissions fetched:", e);
    return [];
  }
}

// Merge Sheet + Submissions
async function loadEvents() {
  const [sheetEvents, subs] = await Promise.all([
    fetchSheetEvents(),
    fetchSubmissions()
  ]);

  let events = [];
  if (Array.isArray(sheetEvents)) events = events.concat(sheetEvents);
  if (Array.isArray(subs)) events = events.concat(subs);

  renderEvents(events);
}

// Render UI
function renderEvents(events) {
  const q = document.getElementById("search").value.toLowerCase();
  const wrap = document.getElementById("events");
  wrap.innerHTML = "";

  events
    .filter(ev => !q || (ev.title && ev.title.toLowerCase().includes(q)))
    .forEach(ev => {
      const card = document.createElement("div");
      card.className = "bg-white rounded shadow p-4 flex flex-col";

      if (ev.image) {
        card.innerHTML += `<img src="${ev.image}" alt="" class="rounded mb-2 h-40 w-full object-cover">`;
      }

      card.innerHTML += `
        <h2 class="text-lg font-semibold">${ev.title || "Untitled"}</h2>
        <p class="text-sm text-gray-500">${ev.location || ""}</p>
        <p class="text-sm text-gray-500">${ev.start || ""}</p>
        <button class="mt-auto bg-purple-600 text-white px-3 py-1 rounded text-sm save-btn">
          Save
        </button>
      `;

      card.querySelector(".save-btn").addEventListener("click", () => saveEvent(ev));
      wrap.appendChild(card);
    });
}

function saveEvent(ev) {
  let saved = JSON.parse(localStorage.getItem("saved") || "[]");
  saved.push(ev);
  localStorage.setItem("saved", JSON.stringify(saved));
  alert("Event saved!");
}

document.getElementById("search").addEventListener("input", loadEvents);
window.addEventListener("load", loadEvents);
</script>
</body>
</html>
